# Foreach å¾ªç¯å¤„ç†å·¥ä½œæµç¤ºä¾‹
# æ‰¹é‡å¤„ç†å¤šä¸ªé¡¹ç›®
kind: Workflow
metadata:
  name: foreach_processing_workflow
  version: "1.0"
  description: ä½¿ç”¨ Foreach å¾ªç¯æ‰¹é‡å¤„ç†å¤šä¸ªä»»åŠ¡é¡¹

variables:
  - name: TaskList
    scope: Local
    type: string
  - name: ParsedTasks
    scope: Local
    type: array
  - name: CurrentTask
    scope: Local
    type: string
  - name: ProcessedResult
    scope: Local
    type: string
  - name: AllResults
    scope: Local
    type: array
  - name: Summary
    scope: Local
    type: string

executors:
  # æ¬¢è¿å’Œè¯´æ˜
  - id: welcome
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          ğŸ“ æ‰¹é‡ä»»åŠ¡å¤„ç†åŠ©æ‰‹
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          æˆ‘å¯ä»¥å¸®æ‚¨æ‰¹é‡å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š
          - æ‰¹é‡ç¿»è¯‘å¤šæ®µæ–‡æœ¬
          - æ‰¹é‡åˆ†æå¤šä¸ªä¸»é¢˜
          - æ‰¹é‡ç”Ÿæˆå¤šä»½å†…å®¹
    edges:
      - targetId: get_tasks

  # è·å–ä»»åŠ¡åˆ—è¡¨
  - id: get_tasks
    type: Question
    properties:
      prompt: |
        è¯·è¾“å…¥æ‚¨è¦å¤„ç†çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰ï¼š
        ä¾‹å¦‚ï¼š
        ç¿»è¯‘ï¼šHello World
        ç¿»è¯‘ï¼šGood Morning
        ç¿»è¯‘ï¼šThank You
      variable: Local.TaskList
    edges:
      - targetId: parse_tasks

  # è§£æä»»åŠ¡åˆ—è¡¨
  - id: parse_tasks
    type: InvokeAzureAgent
    properties:
      agentId: task_parser
      instructions: |
        å°†ä»¥ä¸‹æ–‡æœ¬è§£æä¸ºä»»åŠ¡æ•°ç»„ã€‚
        æ¯è¡Œæ˜¯ä¸€ä¸ªç‹¬ç«‹ä»»åŠ¡ã€‚
        è¿”å› JSON æ•°ç»„æ ¼å¼ï¼š["ä»»åŠ¡1", "ä»»åŠ¡2", ...]
        
        è¾“å…¥ï¼š
        ${Local.TaskList}
      message: è§£æä»»åŠ¡
      result: Local.ParsedTasks
    edges:
      - targetId: show_parsed_tasks

  - id: show_parsed_tasks
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          âœ… è¯†åˆ«åˆ°ä»¥ä¸‹ä»»åŠ¡ï¼š
          ${Local.ParsedTasks}
          
          å¼€å§‹æ‰¹é‡å¤„ç†...
    edges:
      - targetId: init_results

  # åˆå§‹åŒ–ç»“æœæ•°ç»„
  - id: init_results
    type: SetVariable
    properties:
      variable: Local.AllResults
      value: "[]"
    edges:
      - targetId: foreach_tasks

  # Foreach å¾ªç¯å¤„ç†
  - id: foreach_tasks
    type: Foreach
    properties:
      collection: =Local.ParsedTasks
      item: Local.CurrentTask
    edges:
      - targetId: process_task

  # å¤„ç†å•ä¸ªä»»åŠ¡
  - id: process_task
    type: InvokeAzureAgent
    properties:
      agentId: task_processor
      instructions: |
        è¯·å¤„ç†ä»¥ä¸‹ä»»åŠ¡ï¼š
        ${Local.CurrentTask}
        
        è¯†åˆ«ä»»åŠ¡ç±»å‹å¹¶æ‰§è¡Œï¼š
        - å¦‚æœæ˜¯ç¿»è¯‘ä»»åŠ¡ï¼šç¿»è¯‘æˆä¸­æ–‡
        - å¦‚æœæ˜¯åˆ†æä»»åŠ¡ï¼šæä¾›ç®€è¦åˆ†æ
        - å¦‚æœæ˜¯ç”Ÿæˆä»»åŠ¡ï¼šç”Ÿæˆè¯·æ±‚çš„å†…å®¹
        - å…¶ä»–ç±»å‹ï¼šå°½åŠ›å®Œæˆä»»åŠ¡
        
        åªè¿”å›å¤„ç†ç»“æœï¼Œä¸éœ€è¦è§£é‡Šã€‚
      message: =Local.CurrentTask
      result: Local.ProcessedResult
    edges:
      - targetId: show_progress

  - id: show_progress
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          â³ ä»»åŠ¡ï¼š${Local.CurrentTask}
          âœ“ ç»“æœï¼š${Local.ProcessedResult}
    edges:
      - targetId: collect_result

  # æ”¶é›†ç»“æœ
  - id: collect_result
    type: SetVariable
    properties:
      variable: Local.AllResults
      value: "=[...${Local.AllResults}, {task: '${Local.CurrentTask}', result: '${Local.ProcessedResult}'}]"
    edges:
      # è¿”å› Foreach ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œæˆ–ç»“æŸå¾ªç¯
      - targetId: foreach_tasks
        condition: "=hasMoreItems"
      - targetId: summarize_results
        condition: "=!hasMoreItems"

  # æ±‡æ€»æ‰€æœ‰ç»“æœ
  - id: summarize_results
    type: InvokeAzureAgent
    properties:
      agentId: summarizer
      instructions: |
        è¯·ä¸ºä»¥ä¸‹æ‰¹å¤„ç†ç»“æœç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ±‡æ€»ï¼š
        
        ${Local.AllResults}
        
        æ±‡æ€»åº”åŒ…æ‹¬ï¼š
        1. æ€»å…±å¤„ç†äº†å¤šå°‘ä¸ªä»»åŠ¡
        2. å„ä»»åŠ¡çš„ç®€è¦ç»“æœ
        3. æ•´ä½“å®Œæˆæƒ…å†µ
      message: ç”Ÿæˆæ±‡æ€»
      result: Local.Summary
    edges:
      - targetId: final_output

  # æœ€ç»ˆè¾“å‡º
  - id: final_output
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š æ‰¹é‡å¤„ç†å®Œæˆ
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ${Local.Summary}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ‰ æ‰€æœ‰ä»»åŠ¡å·²å¤„ç†å®Œæ¯•ï¼
