# RAG é—®ç­”å·¥ä½œæµç¤ºä¾‹
# æ£€ç´¢å¢å¼ºç”Ÿæˆçš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ
kind: Workflow
metadata:
  name: rag_qa_workflow
  version: "1.0"
  description: åŸºäº RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰çš„æ™ºèƒ½é—®ç­”å·¥ä½œæµ

variables:
  - name: UserQuestion
    scope: Local
    type: string
  - name: SearchQuery
    scope: Local
    type: string
  - name: RetrievedContext
    scope: Local
    type: string
  - name: Answer
    scope: Local
    type: string
  - name: Confidence
    scope: Local
    type: string
  - name: Sources
    scope: Local
    type: string

executors:
  # æ¬¢è¿
  - id: welcome
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          ğŸ¤– æ™ºèƒ½çŸ¥è¯†é—®ç­”åŠ©æ‰‹
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          æˆ‘å¯ä»¥å›ç­”å…³äºäº§å“ã€æŠ€æœ¯æ–‡æ¡£ã€å…¬å¸æ”¿ç­–ç­‰æ–¹é¢çš„é—®é¢˜ã€‚
          æˆ‘ä¼šå…ˆæ£€ç´¢ç›¸å…³çŸ¥è¯†ï¼Œå†ç»™å‡ºå‡†ç¡®çš„å›ç­”ã€‚
    edges:
      - targetId: get_question

  # è·å–é—®é¢˜
  - id: get_question
    type: Question
    properties:
      prompt: "è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š"
      variable: Local.UserQuestion
    edges:
      - targetId: query_understanding

  # é—®é¢˜ç†è§£ä¸æŸ¥è¯¢ä¼˜åŒ–
  - id: query_understanding
    type: InvokeAzureAgent
    properties:
      agentId: query_optimizer
      instructions: |
        ä½ æ˜¯ä¸€ä¸ªæŸ¥è¯¢ä¼˜åŒ–ä¸“å®¶ã€‚
        
        ç”¨æˆ·é—®é¢˜ï¼š${Local.UserQuestion}
        
        è¯·åˆ†æç”¨æˆ·æ„å›¾ï¼Œç”Ÿæˆä¼˜åŒ–çš„æœç´¢æŸ¥è¯¢å…³é”®è¯ã€‚
        è¾“å‡ºæ ¼å¼ï¼š
        - æ ¸å¿ƒå…³é”®è¯ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼‰
        - ç›¸å…³æ‰©å±•è¯
        
        åªè¾“å‡ºå…³é”®è¯ï¼Œä¸éœ€è¦è§£é‡Šã€‚
      message: ä¼˜åŒ–æŸ¥è¯¢
      result: Local.SearchQuery
    edges:
      - targetId: show_search_query

  - id: show_search_query
    type: SendActivity
    properties:
      activity:
        type: message
        text: "ğŸ” æœç´¢å…³é”®è¯ï¼š${Local.SearchQuery}"
    edges:
      - targetId: retrieve_context

  # çŸ¥è¯†æ£€ç´¢ï¼ˆæ¨¡æ‹Ÿï¼‰
  - id: retrieve_context
    type: InvokeAzureAgent
    properties:
      agentId: knowledge_retriever
      instructions: |
        ä½ æ˜¯ä¸€ä¸ªçŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿã€‚
        
        æœç´¢æŸ¥è¯¢ï¼š${Local.SearchQuery}
        åŸå§‹é—®é¢˜ï¼š${Local.UserQuestion}
        
        è¯·æ¨¡æ‹Ÿä»çŸ¥è¯†åº“ä¸­æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ç‰‡æ®µã€‚
        ç”Ÿæˆ3-5ä¸ªç›¸å…³çš„çŸ¥è¯†ç‰‡æ®µï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
        
        [æ–‡æ¡£1: æ ‡é¢˜]
        ç›¸å…³å†…å®¹æ‘˜å½•...
        
        [æ–‡æ¡£2: æ ‡é¢˜]
        ç›¸å…³å†…å®¹æ‘˜å½•...
        
        ç¡®ä¿å†…å®¹çœ‹èµ·æ¥åƒçœŸå®çš„ä¼ä¸šçŸ¥è¯†åº“æ–‡æ¡£ã€‚
      message: æ£€ç´¢çŸ¥è¯†
      result: Local.RetrievedContext
    edges:
      - targetId: show_context

  - id: show_context
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          ğŸ“š æ£€ç´¢åˆ°çš„ç›¸å…³çŸ¥è¯†ï¼š
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ${Local.RetrievedContext}
    edges:
      - targetId: generate_answer

  # ç”Ÿæˆç­”æ¡ˆ
  - id: generate_answer
    type: InvokeAzureAgent
    properties:
      agentId: answer_generator
      instructions: |
        ä½ æ˜¯ä¸€ä¸ªåŸºäºçŸ¥è¯†åº“çš„é—®ç­”ä¸“å®¶ã€‚
        
        ç”¨æˆ·é—®é¢˜ï¼š${Local.UserQuestion}
        
        ç›¸å…³çŸ¥è¯†ï¼š
        ${Local.RetrievedContext}
        
        è¯·åŸºäºæ£€ç´¢åˆ°çš„çŸ¥è¯†å›ç­”ç”¨æˆ·é—®é¢˜ï¼š
        1. ç­”æ¡ˆå¿…é¡»åŸºäºæä¾›çš„çŸ¥è¯†ï¼Œä¸è¦ç¼–é€ 
        2. å¦‚æœçŸ¥è¯†ä¸è¶³ä»¥å›ç­”ï¼Œè¯·è¯šå®è¯´æ˜
        3. å¼•ç”¨çŸ¥è¯†æ¥æº
        4. æä¾›æ¸…æ™°ã€ç»“æ„åŒ–çš„å›ç­”
        
        åœ¨å›ç­”æœ«å°¾è¯„ä¼°ç­”æ¡ˆçš„ç½®ä¿¡åº¦ï¼ˆé«˜/ä¸­/ä½ï¼‰ã€‚
      message: ç”Ÿæˆç­”æ¡ˆ
      result: Local.Answer
    edges:
      - targetId: extract_confidence

  # æå–ç½®ä¿¡åº¦
  - id: extract_confidence
    type: InvokeAzureAgent
    properties:
      agentId: confidence_extractor
      instructions: |
        ä»ä»¥ä¸‹å›ç­”ä¸­æå–ç½®ä¿¡åº¦ã€‚
        åªè¿”å› "é«˜"ã€"ä¸­" æˆ– "ä½" å…¶ä¸­ä¸€ä¸ªã€‚
        
        å›ç­”ï¼š${Local.Answer}
      message: æå–ç½®ä¿¡åº¦
      result: Local.Confidence
    edges:
      - targetId: format_response

  # æ ¼å¼åŒ–å“åº”
  - id: format_response
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ’¡ å›ç­”
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ${Local.Answer}
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ğŸ“Š ç½®ä¿¡åº¦ï¼š${Local.Confidence}
          ğŸ“– åŸºäºçŸ¥è¯†åº“æ£€ç´¢ç»“æœç”Ÿæˆ
    edges:
      - targetId: ask_followup

  # è¯¢é—®åç»­é—®é¢˜
  - id: ask_followup
    type: Question
    properties:
      prompt: "è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿï¼ˆè¾“å…¥é—®é¢˜ç»§ç»­ï¼Œè¾“å…¥'ç»“æŸ'é€€å‡ºï¼‰"
      variable: Local.UserQuestion
    edges:
      - targetId: goodbye
        condition: Local.UserQuestion == 'ç»“æŸ'
      - targetId: query_understanding

  # ç»“æŸ
  - id: goodbye
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          æ„Ÿè°¢ä½¿ç”¨æ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼
          å¦‚æœ‰æ›´å¤šé—®é¢˜ï¼Œéšæ—¶å›æ¥å’¨è¯¢ã€‚ğŸ‘‹
