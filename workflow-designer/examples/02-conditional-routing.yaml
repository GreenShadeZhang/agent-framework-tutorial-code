# æ¡ä»¶åˆ†æ”¯å·¥ä½œæµç¤ºä¾‹
# æ ¹æ®ç”¨æˆ·æ„å›¾è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†åˆ†æ”¯
kind: Workflow
metadata:
  name: conditional_routing_workflow
  version: "1.0"
  description: æ™ºèƒ½è·¯ç”±å·¥ä½œæµï¼Œæ ¹æ®ç”¨æˆ·æ„å›¾åˆ†å‘åˆ°ä¸åŒçš„ä¸“ä¸šå¤„ç†åˆ†æ”¯

variables:
  - name: UserMessage
    scope: Local
    type: string
  - name: Intent
    scope: Local
    type: string
  - name: Response
    scope: Local
    type: string

executors:
  # æ¬¢è¿æ¶ˆæ¯
  - id: welcome
    type: SendActivity
    properties:
      activity:
        type: message
        text: "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½å®¢æœç³»ç»Ÿï¼æˆ‘å¯ä»¥å¸®æ‚¨å¤„ç†ï¼šäº§å“å’¨è¯¢ã€æŠ€æœ¯æ”¯æŒã€æŠ•è¯‰å»ºè®®ç­‰é—®é¢˜ã€‚"
    edges:
      - targetId: get_user_input

  # è·å–ç”¨æˆ·è¾“å…¥
  - id: get_user_input
    type: Question
    properties:
      prompt: "è¯·æè¿°æ‚¨çš„é—®é¢˜ï¼š"
      variable: Local.UserMessage
    edges:
      - targetId: classify_intent

  # æ„å›¾åˆ†ç±»æ™ºèƒ½ä½“
  - id: classify_intent
    type: InvokeAzureAgent
    properties:
      agentId: intent_classifier
      instructions: |
        ä½ æ˜¯ä¸€ä¸ªæ„å›¾åˆ†ç±»å™¨ã€‚æ ¹æ®ç”¨æˆ·æ¶ˆæ¯ï¼Œåˆ¤æ–­ç”¨æˆ·æ„å›¾å¹¶åªè¿”å›ä»¥ä¸‹ç±»åˆ«ä¹‹ä¸€ï¼š
        - PRODUCT: äº§å“å’¨è¯¢ã€ä»·æ ¼è¯¢é—®ã€åŠŸèƒ½äº†è§£
        - TECH: æŠ€æœ¯é—®é¢˜ã€ä½¿ç”¨å¸®åŠ©ã€æ•…éšœæ’é™¤
        - COMPLAINT: æŠ•è¯‰ã€å»ºè®®ã€ä¸æ»¡åé¦ˆ
        - OTHER: å…¶ä»–æ— æ³•åˆ†ç±»çš„é—®é¢˜
        
        åªè¿”å›ç±»åˆ«åç§°ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
      message: =Local.UserMessage
      result: Local.Intent
    edges:
      # æ¡ä»¶è·¯ç”±
      - targetId: product_agent
        condition: Local.Intent == 'PRODUCT'
      - targetId: tech_agent
        condition: Local.Intent == 'TECH'
      - targetId: complaint_agent
        condition: Local.Intent == 'COMPLAINT'
      - targetId: general_agent
        condition: Local.Intent == 'OTHER'

  # äº§å“å’¨è¯¢æ™ºèƒ½ä½“
  - id: product_agent
    type: InvokeAzureAgent
    properties:
      agentId: product_expert
      instructions: |
        ä½ æ˜¯äº§å“å’¨è¯¢ä¸“å®¶ï¼Œçƒ­æƒ…ä¸“ä¸šåœ°å›ç­”ç”¨æˆ·å…³äºäº§å“çš„é—®é¢˜ã€‚
        åŒ…æ‹¬ï¼šäº§å“åŠŸèƒ½ã€ä»·æ ¼ã€å¯¹æ¯”ã€è´­ä¹°å»ºè®®ç­‰ã€‚
        è¯­æ°”å‹å¥½ï¼Œçªå‡ºäº§å“ä¼˜åŠ¿ã€‚
      message: =Local.UserMessage
      result: Local.Response
    edges:
      - targetId: send_response

  # æŠ€æœ¯æ”¯æŒæ™ºèƒ½ä½“
  - id: tech_agent
    type: InvokeAzureAgent
    properties:
      agentId: tech_support
      instructions: |
        ä½ æ˜¯æŠ€æœ¯æ”¯æŒå·¥ç¨‹å¸ˆï¼Œè€å¿ƒä¸“ä¸šåœ°è§£å†³ç”¨æˆ·çš„æŠ€æœ¯é—®é¢˜ã€‚
        æä¾›ï¼š
        1. é—®é¢˜è¯Šæ–­
        2. è§£å†³æ­¥éª¤
        3. é¢„é˜²å»ºè®®
        ä½¿ç”¨æ¸…æ™°çš„æ­¥éª¤è¯´æ˜ã€‚
      message: =Local.UserMessage
      result: Local.Response
    edges:
      - targetId: send_response

  # æŠ•è¯‰å¤„ç†æ™ºèƒ½ä½“
  - id: complaint_agent
    type: InvokeAzureAgent
    properties:
      agentId: complaint_handler
      instructions: |
        ä½ æ˜¯å®¢æˆ·å…³æ€€ä¸“å‘˜ï¼ŒçœŸè¯šåœ°å¤„ç†ç”¨æˆ·çš„æŠ•è¯‰å’Œå»ºè®®ã€‚
        1. é¦–å…ˆè¡¨ç¤ºç†è§£å’Œæ­‰æ„
        2. è®¤çœŸè®°å½•é—®é¢˜
        3. æä¾›è§£å†³æ–¹æ¡ˆæˆ–å‡çº§è·¯å¾„
        4. æ„Ÿè°¢ç”¨æˆ·çš„åé¦ˆ
        è¯­æ°”è¦çœŸè¯šã€æœ‰åŒç†å¿ƒã€‚
      message: =Local.UserMessage
      result: Local.Response
    edges:
      - targetId: send_response

  # é€šç”¨åŠ©æ‰‹æ™ºèƒ½ä½“
  - id: general_agent
    type: InvokeAzureAgent
    properties:
      agentId: general_assistant
      instructions: |
        ä½ æ˜¯é€šç”¨å®¢æœåŠ©æ‰‹ï¼Œå¤„ç†å„ç±»ç»¼åˆé—®é¢˜ã€‚
        å¦‚æœé—®é¢˜è¶…å‡ºä½ çš„èƒ½åŠ›èŒƒå›´ï¼Œè¯·å»ºè®®ç”¨æˆ·è”ç³»äººå·¥å®¢æœã€‚
      message: =Local.UserMessage
      result: Local.Response
    edges:
      - targetId: send_response

  # å‘é€å“åº”
  - id: send_response
    type: SendActivity
    properties:
      activity:
        type: message
        text: =Local.Response
    edges:
      - targetId: ask_continue

  # è¯¢é—®æ˜¯å¦ç»§ç»­
  - id: ask_continue
    type: Question
    properties:
      prompt: "è¿˜æœ‰å…¶ä»–é—®é¢˜å—ï¼Ÿï¼ˆè¾“å…¥é—®é¢˜ç»§ç»­ï¼Œè¾“å…¥'é€€å‡º'ç»“æŸï¼‰"
      variable: Local.UserMessage
    edges:
      - targetId: goodbye
        condition: Local.UserMessage == 'é€€å‡º'
      - targetId: classify_intent

  # ç»“æŸè¯­
  - id: goodbye
    type: SendActivity
    properties:
      activity:
        type: message
        text: "æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ï¼ç¥æ‚¨ç”Ÿæ´»æ„‰å¿«ï¼ğŸ‘‹"
