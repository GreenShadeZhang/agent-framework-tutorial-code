# å¹¶è¡Œæ‰§è¡Œå¤šæ™ºèƒ½ä½“å·¥ä½œæµç¤ºä¾‹
# ä¸‰ä¸ªé¢†åŸŸä¸“å®¶åŒæ—¶åˆ†æç”¨æˆ·é—®é¢˜ï¼Œæœ€åæ±‡æ€»ç»“æœ
kind: Workflow
metadata:
  name: parallel_agents_workflow
  version: "1.0"
  description: å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ™ºèƒ½ä½“ï¼ŒåŒæ—¶è·å–ç ”ç©¶ã€è¥é”€ã€æ³•åŠ¡ä¸‰ä¸ªè§’åº¦çš„åˆ†æ

# å˜é‡å®šä¹‰
variables:
  - name: UserQuery
    scope: Local
    type: string
  - name: ResearchResult
    scope: Local
    type: string
  - name: MarketingResult
    scope: Local
    type: string
  - name: LegalResult
    scope: Local
    type: string
  - name: FinalSummary
    scope: Local
    type: string

# æ‰§è¡Œå™¨å®šä¹‰
executors:
  # å…¥å£ï¼šæ¥æ”¶ç”¨æˆ·è¾“å…¥
  - id: receive_input
    type: Question
    properties:
      prompt: "è¯·è¾“å…¥æ‚¨æƒ³è¦åˆ†æçš„ä¸šåŠ¡åœºæ™¯æˆ–äº§å“æè¿°ï¼š"
      variable: Local.UserQuery
    edges:
      # Fan-out: åŒæ—¶è§¦å‘ä¸‰ä¸ªæ™ºèƒ½ä½“
      - targetId: research_agent
      - targetId: marketing_agent
      - targetId: legal_agent

  # ç ”ç©¶åˆ†æå¸ˆæ™ºèƒ½ä½“
  - id: research_agent
    type: InvokeAzureAgent
    properties:
      agentId: researcher
      instructions: |
        ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¸‚åœºç ”ç©¶åˆ†æå¸ˆã€‚
        è¯·åˆ†æä»¥ä¸‹ä¸šåŠ¡åœºæ™¯ï¼Œæä¾›ï¼š
        1. å¸‚åœºæœºä¼šåˆ†æ
        2. ç«äº‰å¯¹æ‰‹æƒ…å†µ
        3. æ½œåœ¨é£é™©
        ä¿æŒç®€æ´ï¼Œä¸è¶…è¿‡200å­—ã€‚
      message: =Local.UserQuery
      result: Local.ResearchResult
    edges:
      - targetId: aggregate_results

  # è¥é”€ç­–ç•¥å¸ˆæ™ºèƒ½ä½“
  - id: marketing_agent
    type: InvokeAzureAgent
    properties:
      agentId: marketer
      instructions: |
        ä½ æ˜¯ä¸€ä½åˆ›æ„è¥é”€ç­–ç•¥å¸ˆã€‚
        è¯·ä¸ºä»¥ä¸‹åœºæ™¯æä¾›ï¼š
        1. ç›®æ ‡å®¢æˆ·å®šä½
        2. æ ¸å¿ƒä»·å€¼ä¸»å¼ 
        3. è¥é”€æ¸ é“å»ºè®®
        ä¿æŒç®€æ´ï¼Œä¸è¶…è¿‡200å­—ã€‚
      message: =Local.UserQuery
      result: Local.MarketingResult
    edges:
      - targetId: aggregate_results

  # æ³•åŠ¡åˆè§„é¡¾é—®æ™ºèƒ½ä½“
  - id: legal_agent
    type: InvokeAzureAgent
    properties:
      agentId: legal
      instructions: |
        ä½ æ˜¯ä¸€ä½è°¨æ…çš„æ³•åŠ¡åˆè§„é¡¾é—®ã€‚
        è¯·å®¡æŸ¥ä»¥ä¸‹åœºæ™¯ï¼ŒæŒ‡å‡ºï¼š
        1. æ½œåœ¨çš„åˆè§„é£é™©
        2. éœ€è¦æ³¨æ„çš„æ³•å¾‹äº‹é¡¹
        3. å…è´£å£°æ˜å»ºè®®
        ä¿æŒç®€æ´ï¼Œä¸è¶…è¿‡200å­—ã€‚
      message: =Local.UserQuery
      result: Local.LegalResult
    edges:
      - targetId: aggregate_results

  # æ±‡æ€»ç»“æœ (Fan-in)
  - id: aggregate_results
    type: InvokeAzureAgent
    properties:
      agentId: summarizer
      instructions: |
        ä½ æ˜¯ä¸€ä½ç»¼åˆåˆ†æä¸“å®¶ã€‚è¯·å°†ä»¥ä¸‹ä¸‰ä½ä¸“å®¶çš„åˆ†æç»“æœæ•´åˆæˆä¸€ä»½ç®€æ´çš„æ‰§è¡Œæ‘˜è¦ã€‚
        
        ã€ç ”ç©¶åˆ†æã€‘
        ${Local.ResearchResult}
        
        ã€è¥é”€å»ºè®®ã€‘
        ${Local.MarketingResult}
        
        ã€æ³•åŠ¡æ„è§ã€‘
        ${Local.LegalResult}
        
        è¯·æä¾›ä¸€ä»½500å­—ä»¥å†…çš„ç»¼åˆæŠ¥å‘Šï¼ŒåŒ…æ‹¬æ ¸å¿ƒå»ºè®®å’Œæ³¨æ„äº‹é¡¹ã€‚
      message: è¯·æ•´åˆåˆ†æç»“æœ
      result: Local.FinalSummary
    edges:
      - targetId: output_result

  # è¾“å‡ºæœ€ç»ˆç»“æœ
  - id: output_result
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          ğŸ“Š ç»¼åˆåˆ†ææŠ¥å‘Š
          ================
          ${Local.FinalSummary}
