# è¿­ä»£ä¼˜åŒ–å·¥ä½œæµç¤ºä¾‹
# Writer â†’ Reviewer å¾ªçŽ¯ï¼Œç›´åˆ°å†…å®¹è¾¾æ ‡
kind: Workflow
metadata:
  name: iterative_refinement_workflow
  version: "1.0"
  description: å†™ä½œ-è¯„å®¡è¿­ä»£å·¥ä½œæµï¼Œé€šè¿‡å¤šè½®ä¼˜åŒ–äº§å‡ºé«˜è´¨é‡å†…å®¹

variables:
  - name: Topic
    scope: Local
    type: string
  - name: Draft
    scope: Local
    type: string
  - name: Feedback
    scope: Local
    type: string
  - name: IsApproved
    scope: Local
    type: string
  - name: IterationCount
    scope: Local
    type: number
  - name: FinalContent
    scope: Local
    type: string

executors:
  # åˆå§‹åŒ–
  - id: initialize
    type: SetVariable
    properties:
      variable: Local.IterationCount
      value: "0"
    edges:
      - targetId: get_topic

  # èŽ·å–å†™ä½œä¸»é¢˜
  - id: get_topic
    type: Question
    properties:
      prompt: "è¯·è¾“å…¥æ‚¨æƒ³è¦æ’°å†™çš„ä¸»é¢˜æˆ–å†…å®¹è¦æ±‚ï¼š"
      variable: Local.Topic
    edges:
      - targetId: writer_agent

  # å†™ä½œæ™ºèƒ½ä½“
  - id: writer_agent
    type: InvokeAzureAgent
    properties:
      agentId: content_writer
      instructions: |
        ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å†…å®¹å†™ä½œä¸“å®¶ã€‚
        
        å†™ä½œä¸»é¢˜ï¼š${Local.Topic}
        
        ${Local.Feedback != '' ? 'è¯·æ ¹æ®ä»¥ä¸‹åé¦ˆè¿›è¡Œä¿®æ”¹ï¼š\n' + Local.Feedback : 'è¯·æ’°å†™ä¸€ç¯‡é«˜è´¨é‡çš„å†…å®¹ã€‚'}
        
        è¦æ±‚ï¼š
        1. ç»“æž„æ¸…æ™°ï¼Œé€»è¾‘ä¸¥è°¨
        2. è¯­è¨€ç”ŸåŠ¨ï¼Œæ˜“äºŽç†è§£
        3. å†…å®¹å‡†ç¡®ï¼Œæœ‰è¯´æœåŠ›
        
        å½“å‰æ˜¯ç¬¬ ${Local.IterationCount} æ¬¡ä¿®æ”¹ã€‚
      message: è¯·å¼€å§‹å†™ä½œ
      result: Local.Draft
    edges:
      - targetId: increment_counter

  # å¢žåŠ è¿­ä»£è®¡æ•°
  - id: increment_counter
    type: SetVariable
    properties:
      variable: Local.IterationCount
      value: "=${Local.IterationCount + 1}"
    edges:
      - targetId: show_draft

  # æ˜¾ç¤ºå½“å‰è‰ç¨¿
  - id: show_draft
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          ðŸ“ ç¬¬ ${Local.IterationCount} ç‰ˆè‰ç¨¿ï¼š
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ${Local.Draft}
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    edges:
      - targetId: reviewer_agent

  # è¯„å®¡æ™ºèƒ½ä½“
  - id: reviewer_agent
    type: InvokeAzureAgent
    properties:
      agentId: content_reviewer
      instructions: |
        ä½ æ˜¯ä¸€ä½ä¸¥æ ¼çš„å†…å®¹å®¡æ ¸ä¸“å®¶ã€‚
        
        è¯·è¯„å®¡ä»¥ä¸‹å†…å®¹ï¼š
        ${Local.Draft}
        
        è¯„å®¡æ ‡å‡†ï¼š
        1. å†…å®¹å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
        2. ç»“æž„å’Œé€»è¾‘æ¸…æ™°åº¦
        3. è¯­è¨€è¡¨è¾¾è´¨é‡
        4. æ˜¯å¦ç¬¦åˆä¸»é¢˜è¦æ±‚
        
        è¯·è¿”å›žJSONæ ¼å¼ï¼š
        {
          "approved": true/false,
          "feedback": "å…·ä½“çš„æ”¹è¿›å»ºè®®ï¼ˆå¦‚æžœä¸é€šè¿‡ï¼‰"
        }
        
        å¦‚æžœè´¨é‡è¶³å¤Ÿå¥½ï¼ˆè¯„åˆ†>=8/10ï¼‰ï¼Œè®¾ç½® approved ä¸º trueã€‚
        è¿™æ˜¯ç¬¬ ${Local.IterationCount} æ¬¡è¯„å®¡ï¼Œæœ€å¤šå…è®¸3æ¬¡ä¿®æ”¹ã€‚
      message: è¯·è¯„å®¡å†…å®¹
      result: Local.Feedback
    edges:
      - targetId: parse_review

  # è§£æžè¯„å®¡ç»“æžœ
  - id: parse_review
    type: InvokeAzureAgent
    properties:
      agentId: parser
      instructions: |
        ä»Žä»¥ä¸‹è¯„å®¡ç»“æžœä¸­æå– approved å­—æ®µçš„å€¼ã€‚
        åªè¿”å›ž "true" æˆ– "false"ï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
        
        è¯„å®¡ç»“æžœï¼š${Local.Feedback}
      message: æå– approved å€¼
      result: Local.IsApproved
    edges:
      - targetId: check_approval

  # æ£€æŸ¥æ˜¯å¦é€šè¿‡
  - id: check_approval
    type: SendActivity
    properties:
      activity:
        type: message
        text: "ðŸ” è¯„å®¡ç»“æžœï¼š${Local.IsApproved == 'true' ? 'âœ… å·²é€šè¿‡' : 'âŒ éœ€è¦ä¿®æ”¹'}"
    edges:
      - targetId: finalize
        condition: Local.IsApproved == 'true'
      - targetId: check_max_iterations
        condition: Local.IsApproved != 'true'

  # æ£€æŸ¥æœ€å¤§è¿­ä»£æ¬¡æ•°
  - id: check_max_iterations
    type: SendActivity
    properties:
      activity:
        type: message
        text: "å½“å‰è¿­ä»£æ¬¡æ•°ï¼š${Local.IterationCount}/3"
    edges:
      - targetId: force_finalize
        condition: Local.IterationCount >= 3
      - targetId: writer_agent
        condition: Local.IterationCount < 3

  # å¼ºåˆ¶å®Œæˆï¼ˆè¾¾åˆ°æœ€å¤§æ¬¡æ•°ï¼‰
  - id: force_finalize
    type: SetVariable
    properties:
      variable: Local.FinalContent
      value: =Local.Draft
    edges:
      - targetId: output_final_forced

  - id: output_final_forced
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          âš ï¸ å·²è¾¾åˆ°æœ€å¤§ä¿®æ”¹æ¬¡æ•°ï¼ˆ3æ¬¡ï¼‰ï¼Œè¾“å‡ºå½“å‰ç‰ˆæœ¬ï¼š
          
          ðŸ“„ æœ€ç»ˆå†…å®¹ï¼š
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ${Local.FinalContent}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # æ­£å¸¸å®Œæˆ
  - id: finalize
    type: SetVariable
    properties:
      variable: Local.FinalContent
      value: =Local.Draft
    edges:
      - targetId: output_final

  - id: output_final
    type: SendActivity
    properties:
      activity:
        type: message
        text: |
          ðŸŽ‰ å†…å®¹å·²é€šè¿‡è¯„å®¡ï¼
          
          ðŸ“„ æœ€ç»ˆå†…å®¹ï¼š
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ${Local.FinalContent}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          æ€»å…±ç»è¿‡ ${Local.IterationCount} æ¬¡è¿­ä»£ä¼˜åŒ–ã€‚
