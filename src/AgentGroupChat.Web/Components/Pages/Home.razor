@page "/"
@using AgentGroupChat.Models
@using AgentGroupChat.Web.Services
@using AgentGroupChat.Web.Components.Dialogs
@using Markdig
@inject AgentHostClient AgentHostClient
@inject IDialogService DialogService

<PageTitle>Agent Group Chat</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="d-flex" Style="height: calc(100vh - 64px); padding: 0;">
    <!-- Sidebar -->
    <MudPaper Elevation="0" Class="sidebar-panel" Style="width: 320px; border-right: 1px solid var(--mud-palette-divider);">
        <div class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Forum" Class="mr-2" />
                Conversations
            </MudText>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       FullWidth="true" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateNewSessionAsync">
                New Chat
            </MudButton>
        </div>
        
        <MudDivider />
        
        <MudList T="string">
            @foreach (var session in _sessions)
            {
                var groupName = _groups.FirstOrDefault(g => g.Id == session.GroupId)?.Name ?? "æœªçŸ¥ç»„";
                <MudListItem Class="@($"session-list-item {(_currentSession?.Id == session.Id ? "selected" : "")}")"
                             T="string">
                    <div class="d-flex align-center justify-space-between" style="width: 100%;">
                        <div class="d-flex flex-column flex-grow-1" @onclick="() => LoadSession(session.Id)" style="cursor: pointer;">
                            <MudText Typo="Typo.body1"><strong>@session.Name</strong></MudText>
                            <MudText Typo="Typo.body2" Style="@(_currentSession?.Id == session.Id ? "color: rgba(139, 92, 246, 0.8);" : "opacity: 0.7;")">
                                @session.LastUpdated.ToString("MMM dd, HH:mm")
                            </MudText>
                            <MudText Typo="Typo.caption" Style="opacity: 0.6;">
                                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" />
                                @groupName
                            </MudText>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Color="Color.Error" 
                                       Size="Size.Small"
                                       @onclick="() => DeleteSessionWithConfirmation(session.Id)"
                                       title="åˆ é™¤ä¼šè¯"
                                       Class="ml-2" />
                    </div>
                </MudListItem>
            }
        </MudList>
    </MudPaper>

    <!-- Main Chat Area -->
    <div class="d-flex flex-column flex-grow-1">
        <!-- Chat Header -->
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h5" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Class="mr-2" />
                Agent Group Chat
                @if (_currentSession != null)
                {
                    var currentGroup = _groups.FirstOrDefault(g => g.Id == _currentSession.GroupId);
                    if (currentGroup != null)
                    {
                        <MudChip Color="Color.Primary" Size="Size.Small" Class="ml-2" T="string">
                            <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small" Class="mr-1" />
                            @currentGroup.Name
                        </MudChip>
                    }
                }
            </MudText>
            <div class="d-flex flex-wrap gap-2 align-center">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mr-2">Available Agents:</MudText>
                @foreach (var agent in _agents)
                {
                    <MudChip Color="Color.Primary" 
                             Size="Size.Small" 
                             Variant="Variant.Outlined"
                             title="@agent.Description"
                             T="string">
                        @agent.Avatar @agent.Name
                    </MudChip>
                }
            </div>
        </MudPaper>

        <!-- Messages Container -->
        <div class="flex-grow-1 overflow-auto pa-4 messages-container" style="background: linear-gradient(to bottom, #f5f3ff 0%, #ffffff 100%);" @ref="_messagesContainer">
            @if (_currentSession?.Messages != null)
            {
                @foreach (var msg in _currentSession.Messages)
                {
                    <div class="mb-3 d-flex @(msg.IsUser ? "justify-end" : "justify-start")">
                        @if (!msg.IsUser)
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-2 avatar-top" Style="flex-shrink: 0;">
                                @msg.AgentAvatar
                            </MudAvatar>
                        }
                        
                        <div class="message-wrapper" style="max-width: 70%;">
                            @if (!msg.IsUser)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Primary" Class="mb-1 ml-1">
                                    <strong>@msg.AgentName</strong>
                                </MudText>
                            }
                            
                            <MudPaper Elevation="1" 
                                      Class="@($"message-bubble {(msg.IsUser ? "user-message" : "agent-message")}")"
                                      Style="@(msg.IsUser ? "background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white; border-radius: 18px 18px 4px 18px;" : "background: white; border-radius: 18px 18px 18px 4px;")">
                                <MudText Typo="Typo.body2" Style="@(msg.IsUser ? "color: white;" : "color: #1e1e1e;")">
                                    @((MarkupString)Markdown.ToHtml(msg.Content ?? string.Empty))
                                </MudText>
                                
                                @if (!string.IsNullOrEmpty(msg.ImageUrl))
                                {
                                    <div class="mt-2">
                                        <MudImage Src="@msg.ImageUrl" 
                                                  Alt="Shared image" 
                                                  Class="message-image" 
                                                  Style="max-width: 100%; max-height: 300px; width: auto; height: auto; border-radius: 12px; display: block; object-fit: contain;" />
                                    </div>
                                }
                                
                                <MudText Typo="Typo.caption" Class="mt-1" Style="@(msg.IsUser ? "color: rgba(255,255,255,0.8); font-size: 0.7rem;" : "color: #999; font-size: 0.7rem;")">
                                    @msg.Timestamp.ToString("HH:mm")
                                </MudText>
                            </MudPaper>
                        </div>
                        
                        @if (msg.IsUser)
                        {
                            <MudAvatar Color="Color.Success" Size="Size.Medium" Class="ml-2 avatar-top" Style="flex-shrink: 0;">
                                <MudIcon Icon="@Icons.Material.Filled.Person" />
                            </MudAvatar>
                        }
                    </div>
                }
            }
            
            @if (_isLoading)
            {
                <div class="mb-3 d-flex justify-start">
                    <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-2" Style="flex-shrink: 0;">
                        <MudIcon Icon="@Icons.Material.Filled.HourglassBottom" />
                    </MudAvatar>
                    <MudPaper Elevation="1" Class="pa-3 agent-message" Style="background: white; border-radius: 18px 18px 18px 4px;">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
                        <MudText Typo="Typo.body2" Class="ml-2 d-inline">æ€è€ƒä¸­...</MudText>
                    </MudPaper>
                </div>
            }
        </div>

        <!-- Input Area -->
        <MudPaper Elevation="3" Class="pa-4">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                ğŸ’¡ Tip: Use @("@") to mention an agent (e.g., @("@")Sunny, @("@")Techie, @("@")Artsy, @("@")Foodie)
            </MudAlert>
            
            <div class="d-flex gap-3 align-end">
                <MudTextField @bind-Value="_inputMessage" 
                              Placeholder="@PlaceholderText"
                              Variant="Variant.Outlined" 
                              Lines="3"
                              Disabled="_isLoading"
                              Immediate="true"
                              OnKeyDown="HandleKeyPress"
                              Class="flex-grow-1" />
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           EndIcon="@Icons.Material.Filled.Send"
                           Size="Size.Large"
                           OnClick="SendMessage"
                           Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_inputMessage))">
                    Send
                </MudButton>
            </div>
        </MudPaper>
    </div>
</MudContainer>

@code {
    private const string PlaceholderText = "Type your message... Use @ to mention an agent";
    private List<ChatSession> _sessions = new();
    private ChatSession? _currentSession;
    private List<AgentProfile> _agents = new();
    private List<AgentGroup> _groups = new();
    private string _inputMessage = string.Empty;
    private bool _isLoading = false;
    private ElementReference _messagesContainer;

    protected override async Task OnInitializedAsync()
    {
        // Load agents and groups from API
        _agents = await AgentHostClient.GetAgentsAsync();
        _groups = await AgentHostClient.GetAllGroupsAsync();
        
        // Load sessions from API
        await LoadSessionsAsync();
        
        // Create a default session if none exist
        if (_sessions.Count == 0)
        {
            await CreateNewSessionAsync();
        }
        else
        {
            // åŠ è½½ç¬¬ä¸€ä¸ªä¼šè¯åŠå…¶å†å²æ¶ˆæ¯
            await LoadSession(_sessions.First().Id);
        }
    }

    private async Task LoadSessionsAsync()
    {
        _sessions = await AgentHostClient.GetSessionsAsync();
        StateHasChanged();
    }

    private async Task CreateNewSessionAsync()
    {
        // å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç»„ï¼Œæç¤ºç”¨æˆ·
        if (_groups == null || _groups.Count == 0)
        {
            var initDialog = await DialogService.ShowMessageBox(
                "æç¤º",
                "æ²¡æœ‰å¯ç”¨çš„ Agent Groupã€‚æ˜¯å¦åˆå§‹åŒ–é»˜è®¤æ•°æ®ï¼Ÿ",
                yesText: "åˆå§‹åŒ–",
                cancelText: "å–æ¶ˆ");

            if (initDialog == true)
            {
                var success = await AgentHostClient.InitializeDefaultDataAsync();
                if (success)
                {
                    _groups = await AgentHostClient.GetAllGroupsAsync();
                    _agents = await AgentHostClient.GetAgentsAsync();
                }
                else
                {
                    return;
                }
            }
            else
            {
                return;
            }
        }

        // æ˜¾ç¤ºé€‰æ‹© Agent Group çš„å¯¹è¯æ¡†
        var parameters = new DialogParameters
        {
            { "Groups", _groups }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<SelectGroupDialog>("é€‰æ‹© Agent Group", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string selectedGroupId)
        {
            // ä½¿ç”¨é€‰ä¸­çš„ groupId åˆ›å»ºä¼šè¯
            var newSession = await AgentHostClient.CreateSessionAsync(selectedGroupId);
            if (newSession != null)
            {
                _currentSession = newSession;
                _sessions.Insert(0, newSession);
                StateHasChanged();
            }
        }
    }

    private async Task LoadSession(string sessionId)
    {
        // åŠ è½½ä¼šè¯åŸºæœ¬ä¿¡æ¯
        _currentSession = await AgentHostClient.GetSessionAsync(sessionId);
        
        // åŠ è½½ä¼šè¯çš„å†å²æ¶ˆæ¯
        if (_currentSession != null)
        {
            var history = await AgentHostClient.GetConversationHistoryAsync(sessionId);
            _currentSession.Messages = history;
        }
        
        StateHasChanged();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage) || _currentSession == null)
            return;

        _isLoading = true;
        var userMessage = _inputMessage;
        _inputMessage = string.Empty;

        // âœ… ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆä¹è§‚ UI æ›´æ–°ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼‰
        var userMsg = new ChatMessage
        {
            Content = userMessage,
            IsUser = true,
            Timestamp = DateTime.UtcNow,
            MessageType = "text"
        };
        _currentSession.Messages.Add(userMsg);
        StateHasChanged();

        try
        {
            // å‘é€æ¶ˆæ¯åˆ° APIï¼Œåç«¯è¿”å›å®Œæ•´åˆ—è¡¨ï¼ˆç”¨æˆ·æ¶ˆæ¯ + AI å›å¤ï¼‰
            var responses = await AgentHostClient.SendMessageAsync(_currentSession.Id, userMessage);
            
            // âœ… åªæ·»åŠ  AI çš„å›å¤ï¼ˆè·³è¿‡ç”¨æˆ·æ¶ˆæ¯ï¼Œå› ä¸ºå·²ç»æ˜¾ç¤ºäº†ï¼‰
            foreach (var response in responses)
            {
                if (!response.IsUser) // åªæ·»åŠ  AI å›å¤ï¼Œä¸é‡å¤æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                {
                    _currentSession.Messages.Add(response);
                }
            }
        }
        catch (Exception ex)
        {
            // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œç§»é™¤ä¹è§‚æ·»åŠ çš„ç”¨æˆ·æ¶ˆæ¯
            _currentSession.Messages.Remove(userMsg);
            
            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            _currentSession.Messages.Add(new ChatMessage
            {
                AgentId = "system",
                AgentName = "System",
                AgentAvatar = "âš ï¸",
                Content = $"Error: {ex.Message}. Please try again.",
                IsUser = false,
                MessageType = "error",
                Timestamp = DateTime.UtcNow
            });
            
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    /// <summary>
    /// åˆ é™¤ä¼šè¯ï¼ˆå¸¦ç¡®è®¤å¯¹è¯æ¡†ï¼‰
    /// </summary>
    private async Task DeleteSessionWithConfirmation(string sessionId)
    {
        var session = _sessions.FirstOrDefault(s => s.Id == sessionId);
        if (session == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"ç¡®å®šè¦åˆ é™¤ä¼šè¯ \"{session.Name}\" å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œä¸”ä¸å¯æ¢å¤ã€‚",
            ["ButtonText"] = "åˆ é™¤",
            ["Color"] = Color.Error
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true 
        };

        var dialog = await DialogService.ShowMessageBox(
            "ç¡®è®¤åˆ é™¤", 
            $"ç¡®å®šè¦åˆ é™¤ä¼šè¯ \"{session.Name}\" å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œä¸”ä¸å¯æ¢å¤ã€‚",
            yesText: "åˆ é™¤",
            cancelText: "å–æ¶ˆ");

        if (dialog == true)
        {
            await DeleteSession(sessionId);
        }
    }

    /// <summary>
    /// åˆ é™¤ä¼šè¯çš„æ ¸å¿ƒé€»è¾‘
    /// </summary>
    private async Task DeleteSession(string sessionId)
    {
        try
        {
            // è°ƒç”¨ API åˆ é™¤ä¼šè¯ï¼ˆåç«¯ä¼šçº§è”åˆ é™¤æ¶ˆæ¯ï¼‰
            var success = await AgentHostClient.DeleteSessionAsync(sessionId);
            
            if (success)
            {
                // ä»åˆ—è¡¨ä¸­ç§»é™¤
                var deletedSession = _sessions.FirstOrDefault(s => s.Id == sessionId);
                if (deletedSession != null)
                {
                    _sessions.Remove(deletedSession);
                }

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œéœ€è¦åˆ‡æ¢åˆ°å…¶ä»–ä¼šè¯
                if (_currentSession?.Id == sessionId)
                {
                    if (_sessions.Count > 0)
                    {
                        // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªä¼šè¯
                        await LoadSession(_sessions.First().Id);
                    }
                    else
                    {
                        // æ²¡æœ‰ä¼šè¯äº†ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
                        await CreateNewSessionAsync();
                    }
                }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting session: {ex.Message}");
            // å¯ä»¥æ·»åŠ é”™è¯¯æç¤º
        }
    }
}
