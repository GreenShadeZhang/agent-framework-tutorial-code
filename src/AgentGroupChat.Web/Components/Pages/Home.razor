@page "/"
@using AgentGroupChat.Models
@using AgentGroupChat.Web.Services
@inject AgentHostClient AgentHostClient

<PageTitle>Agent Group Chat</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="d-flex" Style="height: calc(100vh - 64px); padding: 0;">
    <!-- Sidebar -->
    <MudPaper Elevation="0" Class="sidebar-panel" Style="width: 320px; border-right: 1px solid var(--mud-palette-divider);">
        <div class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Forum" Class="mr-2" />
                Conversations
            </MudText>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       FullWidth="true" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="CreateNewSessionAsync">
                New Chat
            </MudButton>
        </div>
        
        <MudDivider />
        
        <MudList T="string">
            @foreach (var session in _sessions)
            {
                <MudListItem OnClick="() => LoadSession(session.Id)" 
                             Class="@(_currentSession?.Id == session.Id ? "mud-primary-text" : "")"
                             Style="@(_currentSession?.Id == session.Id ? "background-color: var(--mud-palette-primary-lighten); border-left: 3px solid var(--mud-palette-primary);" : "")"
                             T="string">
                    <div class="d-flex flex-column" style="width: 100%;">
                        <MudText Typo="Typo.body1"><strong>@session.Name</strong></MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@session.LastUpdated.ToString("MMM dd, HH:mm")</MudText>
                    </div>
                </MudListItem>
            }
        </MudList>
    </MudPaper>

    <!-- Main Chat Area -->
    <div class="d-flex flex-column flex-grow-1">
        <!-- Chat Header -->
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h5" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.SmartToy" Class="mr-2" />
                Agent Group Chat
            </MudText>
            <div class="d-flex flex-wrap gap-2 align-center">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mr-2">Available Agents:</MudText>
                @foreach (var agent in _agents)
                {
                    <MudChip Color="Color.Primary" 
                             Size="Size.Small" 
                             Variant="Variant.Outlined"
                             title="@agent.Description"
                             T="string">
                        @agent.Avatar @agent.Name
                    </MudChip>
                }
            </div>
        </MudPaper>

        <!-- Messages Container -->
        <div class="flex-grow-1 overflow-auto pa-4" style="background: linear-gradient(to bottom, #f5f3ff 0%, #ffffff 100%);" @ref="_messagesContainer">
            @if (_currentSession?.Messages != null)
            {
                @foreach (var msg in _currentSession.Messages)
                {
                    <div class="mb-4 d-flex @(msg.IsUser ? "justify-end" : "justify-start")">
                        @if (!msg.IsUser)
                        {
                            <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-3" Style="align-self: flex-start;">
                                @msg.AgentAvatar
                            </MudAvatar>
                        }
                        
                        <div style="max-width: 65%;">
                            @if (!msg.IsUser)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Primary" Class="mb-1 ml-2">
                                    <strong>@msg.AgentName</strong>
                                </MudText>
                            }
                            
                            <MudPaper Elevation="2" 
                                      Class="pa-3" 
                                      Style="@(msg.IsUser ? "background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-secondary) 100%); color: white;" : "")">
                                <MudText Typo="Typo.body2" Style="@(msg.IsUser ? "color: white;" : "")">
                                    @msg.Content
                                </MudText>
                                
                                @if (!string.IsNullOrEmpty(msg.ImageUrl))
                                {
                                    <MudImage Src="@msg.ImageUrl" 
                                              Alt="Shared image" 
                                              Class="mt-2 rounded" 
                                              Style="max-width: 100%;" />
                                }
                                
                                <MudText Typo="Typo.caption" Class="mt-1" Style="@(msg.IsUser ? "color: rgba(255,255,255,0.7);" : "opacity: 0.6;")">
                                    @msg.Timestamp.ToString("HH:mm")
                                </MudText>
                            </MudPaper>
                        </div>
                        
                        @if (msg.IsUser)
                        {
                            <MudAvatar Color="Color.Success" Size="Size.Medium" Class="ml-3" Style="align-self: flex-start;">
                                <MudIcon Icon="@Icons.Material.Filled.Person" />
                            </MudAvatar>
                        }
                    </div>
                }
            }
            
            @if (_isLoading)
            {
                <div class="mb-4 d-flex justify-start">
                    <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-3">
                        <MudIcon Icon="@Icons.Material.Filled.HourglassBottom" />
                    </MudAvatar>
                    <MudPaper Elevation="2" Class="pa-3">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
                        <MudText Typo="Typo.body2" Class="ml-2 d-inline">Thinking...</MudText>
                    </MudPaper>
                </div>
            }
        </div>

        <!-- Input Area -->
        <MudPaper Elevation="3" Class="pa-4">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                ğŸ’¡ Tip: Use @("@") to mention an agent (e.g., @("@")Sunny, @("@")Techie, @("@")Artsy, @("@")Foodie)
            </MudAlert>
            
            <div class="d-flex gap-3 align-end">
                <MudTextField @bind-Value="_inputMessage" 
                              Placeholder="@PlaceholderText"
                              Variant="Variant.Outlined" 
                              Lines="3"
                              Disabled="_isLoading"
                              Immediate="true"
                              OnKeyDown="HandleKeyPress"
                              Class="flex-grow-1" />
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           EndIcon="@Icons.Material.Filled.Send"
                           Size="Size.Large"
                           OnClick="SendMessage"
                           Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_inputMessage))">
                    Send
                </MudButton>
            </div>
        </MudPaper>
    </div>
</MudContainer>

@code {
    private const string PlaceholderText = "Type your message... Use @ to mention an agent";
    private List<ChatSession> _sessions = new();
    private ChatSession? _currentSession;
    private List<AgentProfile> _agents = new();
    private string _inputMessage = string.Empty;
    private bool _isLoading = false;
    private ElementReference _messagesContainer;

    protected override async Task OnInitializedAsync()
    {
        // Load agents from API
        _agents = await AgentHostClient.GetAgentsAsync();
        
        // Load sessions from API
        await LoadSessionsAsync();
        
        // Create a default session if none exist
        if (_sessions.Count == 0)
        {
            await CreateNewSessionAsync();
        }
        else
        {
            // åŠ è½½ç¬¬ä¸€ä¸ªä¼šè¯åŠå…¶å†å²æ¶ˆæ¯
            await LoadSession(_sessions.First().Id);
        }
    }

    private async Task LoadSessionsAsync()
    {
        _sessions = await AgentHostClient.GetSessionsAsync();
        StateHasChanged();
    }

    private async Task CreateNewSessionAsync()
    {
        var newSession = await AgentHostClient.CreateSessionAsync();
        if (newSession != null)
        {
            _currentSession = newSession;
            _sessions.Insert(0, newSession);
            StateHasChanged();
        }
    }

    private async Task LoadSession(string sessionId)
    {
        // åŠ è½½ä¼šè¯åŸºæœ¬ä¿¡æ¯
        _currentSession = await AgentHostClient.GetSessionAsync(sessionId);
        
        // åŠ è½½ä¼šè¯çš„å†å²æ¶ˆæ¯
        if (_currentSession != null)
        {
            var history = await AgentHostClient.GetConversationHistoryAsync(sessionId);
            _currentSession.Messages = history;
        }
        
        StateHasChanged();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage) || _currentSession == null)
            return;

        _isLoading = true;
        var userMessage = _inputMessage;
        _inputMessage = string.Empty;

        // âœ… ç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆä¹è§‚ UI æ›´æ–°ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼‰
        var userMsg = new ChatMessage
        {
            Content = userMessage,
            IsUser = true,
            Timestamp = DateTime.UtcNow,
            MessageType = "text"
        };
        _currentSession.Messages.Add(userMsg);
        StateHasChanged();

        try
        {
            // å‘é€æ¶ˆæ¯åˆ° APIï¼Œåç«¯è¿”å›å®Œæ•´åˆ—è¡¨ï¼ˆç”¨æˆ·æ¶ˆæ¯ + AI å›å¤ï¼‰
            var responses = await AgentHostClient.SendMessageAsync(_currentSession.Id, userMessage);
            
            // âœ… åªæ·»åŠ  AI çš„å›å¤ï¼ˆè·³è¿‡ç”¨æˆ·æ¶ˆæ¯ï¼Œå› ä¸ºå·²ç»æ˜¾ç¤ºäº†ï¼‰
            foreach (var response in responses)
            {
                if (!response.IsUser) // åªæ·»åŠ  AI å›å¤ï¼Œä¸é‡å¤æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                {
                    _currentSession.Messages.Add(response);
                }
            }
        }
        catch (Exception ex)
        {
            // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œç§»é™¤ä¹è§‚æ·»åŠ çš„ç”¨æˆ·æ¶ˆæ¯
            _currentSession.Messages.Remove(userMsg);
            
            // æ·»åŠ é”™è¯¯æ¶ˆæ¯
            _currentSession.Messages.Add(new ChatMessage
            {
                AgentId = "system",
                AgentName = "System",
                AgentAvatar = "âš ï¸",
                Content = $"Error: {ex.Message}. Please try again.",
                IsUser = false,
                MessageType = "error",
                Timestamp = DateTime.UtcNow
            });
            
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }
}
