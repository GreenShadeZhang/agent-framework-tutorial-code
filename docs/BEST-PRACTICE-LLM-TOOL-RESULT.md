# æœ€ä½³å®è·µï¼šè®© LLM è‡ªåŠ¨å¤„ç†å·¥å…·ç»“æœ

## ğŸ¯ æ ¸å¿ƒç†å¿µ

**è®© LLM åšå®ƒæœ€æ“…é•¿çš„äº‹æƒ…ï¼šç†è§£ã€æ•´åˆå’Œæ¶¦è‰²å·¥å…·ç»“æœã€‚**

## âŒ é”™è¯¯çš„å®ç°æ–¹å¼ï¼ˆä¹‹å‰çš„åšæ³•ï¼‰

### é—®é¢˜1: æ‰‹åŠ¨æå–å·¥å…·ç»“æœ
```csharp
case FunctionResultContent functionResult:
    // âŒ é”™è¯¯ï¼šæ‰‹åŠ¨è§£æå·¥å…·ç»“æœ
    var toolResult = ExtractToolResult(functionResult, currentExecutorId);
    currentSummary.Content += toolResult;  // âŒ ç›´æ¥è¿½åŠ åŸå§‹ç»“æœ
    break;
```

**é—®é¢˜æ‰€åœ¨:**
- âŒ ç»•è¿‡äº† LLM çš„å¤„ç†æµç¨‹
- âŒ åªé’ˆå¯¹ç‰¹å®šæ ¼å¼ï¼ˆå›¾ç‰‡ URLï¼‰æœ‰æ•ˆ
- âŒ å…¶ä»–ç±»å‹å·¥å…·ï¼ˆæ–‡æœ¬ç”Ÿæˆã€æ•°æ®æŸ¥è¯¢ç­‰ï¼‰ä¼šå¤±è´¥
- âŒ å¤±å»äº† LLM çš„æ¶¦è‰²å’Œä¸Šä¸‹æ–‡æ•´åˆèƒ½åŠ›
- âŒ ç”¨æˆ·çœ‹åˆ°çš„æ˜¯åŸå§‹ã€æœªæ¶¦è‰²çš„æ•°æ®

### é—®é¢˜2: ä¸é€šç”¨çš„è§£æé€»è¾‘
```csharp
// âŒ åªèƒ½å¤„ç†å›¾ç‰‡ URL
if (resultText.Contains(".jpg") || resultText.Contains(".png"))
{
    return $"\n\n![Generated Image]({imageUrl})\n";
}
```

**å±€é™æ€§:**
- âŒ åªé€‚ç”¨äºæ–‡ç”Ÿå›¾å·¥å…·
- âŒ å¯¹äºæ–‡æœ¬ç”Ÿæˆã€æ•°æ®æŸ¥è¯¢ã€è®¡ç®—ç­‰å·¥å…·å®Œå…¨å¤±æ•ˆ
- âŒ éœ€è¦ä¸ºæ¯ç§å·¥å…·ç±»å‹ç¼–å†™ç‰¹å®šé€»è¾‘
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ‰©å±•æ€§å·®

## âœ… æ­£ç¡®çš„å®ç°æ–¹å¼ï¼ˆæœ€ä½³å®è·µï¼‰

### æ ¸å¿ƒåŸç†

```
ç”¨æˆ·æ¶ˆæ¯
    â†“
LLM åˆ†æå¹¶å†³å®šè°ƒç”¨å·¥å…·
    â†“
[FunctionCallContent] â†’ å·¥å…·è¢«è°ƒç”¨
    â†“
[FunctionResultContent] â†’ å·¥å…·è¿”å›ç»“æœ
    â†“
âœ… ç»“æœè‡ªåŠ¨å‘å› LLM (ç”± FunctionInvokingChatClient å¤„ç†)
    â†“
âœ… LLM åŸºäºç»“æœç”Ÿæˆæ¶¦è‰²åçš„æ–‡æœ¬
    â†“
[TextContent] â†’ æˆ‘ä»¬æå–çš„æœ€ç»ˆå“åº”
```

### å®ç°ä»£ç 

```csharp
if (currentSummary != null)
{
    // âœ… åªè®°å½• Tool è°ƒç”¨è¿‡ç¨‹ï¼ˆç”¨äºç›‘æ§å’Œè°ƒè¯•ï¼‰
    foreach (var content in agentUpdate.Update.Contents)
    {
        switch (content)
        {
            case FunctionCallContent functionCall:
                // è®°å½•å·¥å…·è°ƒç”¨
                _logger?.LogInformation(
                    "ğŸ”§ Tool Call | Function: {Name}",
                    functionCall.Name);
                break;

            case FunctionResultContent functionResult:
                // è®°å½•å·¥å…·ç»“æœï¼ˆä»…ç›‘æ§ï¼Œä¸æå–ï¼‰
                _logger?.LogInformation(
                    "âœ… Tool Result | CallId: {CallId}",
                    functionResult.CallId);
                break;
        }
    }

    // âœ… åªç´¯ç§¯ LLM ç”Ÿæˆçš„æœ€ç»ˆæ–‡æœ¬
    // LLM å·²ç»å¤„ç†å’Œæ¶¦è‰²äº†å·¥å…·ç»“æœ
    if (!string.IsNullOrEmpty(agentUpdate.Update.Text))
    {
        currentSummary.Content += agentUpdate.Update.Text;
    }
}
```

## ğŸ¨ å®é™…æ•ˆæœå¯¹æ¯”

### åœºæ™¯1: æ–‡ç”Ÿå›¾å·¥å…·

#### âŒ é”™è¯¯å®ç°çš„ç»“æœ
```
ç”¨æˆ·: è¯·ç”Ÿæˆä¸€å¼ å¤•é˜³é£æ™¯ç”»

Agent: 
![Generated Image](https://dashscope.aliyuncs.com/xxx/image.png)
```
- æ²¡æœ‰ä¸Šä¸‹æ–‡
- æ²¡æœ‰è¯´æ˜
- ç”¨æˆ·ä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆ

#### âœ… æ­£ç¡®å®ç°çš„ç»“æœ
```
ç”¨æˆ·: è¯·ç”Ÿæˆä¸€å¼ å¤•é˜³é£æ™¯ç”»

Agent: æˆ‘ä¸ºæ‚¨åˆ›ä½œäº†ä¸€å¹…ç¾ä¸½çš„å¤•é˜³é£æ™¯ç”»ã€‚ç”»é¢ä¸­å±•ç°äº†æ¸©æš–çš„æ©™çº¢è‰²å¤©ç©ºï¼Œ
å¤ªé˜³ç¼“ç¼“è½ä¸‹ï¼Œåœ°å¹³çº¿ä¸Šæœ‰èµ·ä¼çš„å±±å³¦å‰ªå½±ã€‚æ•´ä½“è‰²è°ƒæ¸©é¦¨æµªæ¼«ï¼Œéå¸¸é€‚åˆä½œä¸º
å£çº¸æˆ–è£…é¥°ç”»ä½¿ç”¨ã€‚

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥æŸ¥çœ‹å’Œä¸‹è½½ï¼š
https://dashscope.aliyuncs.com/xxx/image.png
```
- âœ… æœ‰æ¸…æ™°çš„è¯´æ˜
- âœ… æè¿°äº†å›¾ç‰‡å†…å®¹
- âœ… æä¾›äº†ä½¿ç”¨å»ºè®®
- âœ… æ ¼å¼åŒ–è‰¯å¥½

### åœºæ™¯2: æ•°æ®æŸ¥è¯¢å·¥å…·

å‡è®¾å·¥å…·è¿”å›ï¼š
```json
{"results": ["https://example.com/data1.csv", "https://example.com/data2.csv"], "count": 2}
```

#### âŒ é”™è¯¯å®ç°çš„ç»“æœ
```
Agent: 
```json
{
  "results": ["https://example.com/data1.csv", "https://example.com/data2.csv"],
  "count": 2
}
```
```
- åŸå§‹ JSON æ•°æ®
- ç”¨æˆ·éœ€è¦è‡ªå·±ç†è§£

#### âœ… æ­£ç¡®å®ç°çš„ç»“æœ
```
Agent: æˆ‘å·²ç»ä¸ºæ‚¨æŸ¥è¯¢åˆ° 2 ä¸ªç›¸å…³çš„æ•°æ®æ–‡ä»¶ï¼š

1. æ•°æ®æ–‡ä»¶ 1: https://example.com/data1.csv
2. æ•°æ®æ–‡ä»¶ 2: https://example.com/data2.csv

è¿™äº›æ–‡ä»¶åŒ…å«äº†æ‚¨éœ€è¦çš„æ•°æ®ï¼Œæ‚¨å¯ä»¥ç›´æ¥ä¸‹è½½ä½¿ç”¨ã€‚
```
- âœ… è‡ªç„¶è¯­è¨€è¡¨è¿°
- âœ… æ ¼å¼åŒ–åˆ—è¡¨
- âœ… æ¸…æ™°çš„æŒ‡å¼•

### åœºæ™¯3: æ–‡æœ¬ç”Ÿæˆå·¥å…·

å‡è®¾å·¥å…·è¿”å›ï¼š
```json
{"content": [{"type": "text", "text": "æ ¹æ®åˆ†æï¼Œå»ºè®®é‡‡ç”¨æ–¹æ¡ˆA..."}]}
```

#### âŒ é”™è¯¯å®ç°çš„ç»“æœ
```
Agent: âŒ (è§£æå¤±è´¥ï¼Œå› ä¸ºä¸æ˜¯å›¾ç‰‡ URL)
```

#### âœ… æ­£ç¡®å®ç°çš„ç»“æœ
```
Agent: æˆ‘å·²ç»å®Œæˆäº†åˆ†æã€‚æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯å’Œæ•°æ®ï¼Œæˆ‘çš„å»ºè®®å¦‚ä¸‹ï¼š

å»ºè®®é‡‡ç”¨æ–¹æ¡ˆ Aï¼Œä¸»è¦åŸå› æ˜¯ï¼š
1. æˆæœ¬æ•ˆç›Šæ›´é«˜
2. å®æ–½å‘¨æœŸæ›´çŸ­
3. é£é™©æ›´å¯æ§

è¯¦ç»†çš„åˆ†æç»“æœè¡¨æ˜ï¼Œæ–¹æ¡ˆ A åœ¨å¤šä¸ªç»´åº¦ä¸Šéƒ½ä¼˜äºå…¶ä»–é€‰é¡¹ã€‚
æ‚¨æ˜¯å¦éœ€è¦æ›´è¯¦ç»†çš„å¯¹æ¯”åˆ†æï¼Ÿ
```
- âœ… LLM ç†è§£äº†å·¥å…·ç»“æœ
- âœ… é‡æ–°ç»„ç»‡å’Œæ¶¦è‰²
- âœ… æä¾›äº†ç»“æ„åŒ–è¾“å‡º
- âœ… ä¸»åŠ¨è¯¢é—®åç»­éœ€æ±‚

## ğŸ”§ å¢å¼º System Prompt

ä¸ºäº†ç¡®ä¿ LLM èƒ½å¤Ÿæ­£ç¡®å¤„ç†å·¥å…·ç»“æœï¼Œæˆ‘ä»¬åœ¨ Specialist Agent çš„ System Prompt ä¸­æ·»åŠ äº†æ˜ç¡®çš„æŒ‡ç¤ºï¼š

```csharp
instructions: profile.SystemPrompt +
    "\n\nWhen using tools:" +
    "\n- After calling a tool, ALWAYS wait for the result and incorporate it into your response." +
    "\n- Present tool results in a clear, user-friendly format." +
    "\n- For image URLs, describe what was generated and provide the link." +
    "\n- For data results, summarize key information in a readable way." +
    "\n- Never just return raw tool output - always add context and explanation."
```

**å…³é”®è¦ç‚¹:**
1. âœ… ç­‰å¾…å·¥å…·ç»“æœ
2. âœ… æ•´åˆåˆ°å“åº”ä¸­
3. âœ… ä½¿ç”¨ç”¨æˆ·å‹å¥½çš„æ ¼å¼
4. âœ… é’ˆå¯¹ä¸åŒç±»å‹å†…å®¹æä¾›é€‚å½“çš„å‘ˆç°æ–¹å¼
5. âœ… æ·»åŠ ä¸Šä¸‹æ–‡å’Œè§£é‡Š

## ğŸ“Š æ—¥å¿—è®°å½•æœ€ä½³å®è·µ

è™½ç„¶æˆ‘ä»¬ä¸æ‰‹åŠ¨æå–å·¥å…·ç»“æœï¼Œä½†è¯¦ç»†çš„æ—¥å¿—å¯¹äºç›‘æ§å’Œè°ƒè¯•éå¸¸é‡è¦ï¼š

```csharp
case FunctionCallContent functionCall:
    _logger?.LogInformation(
        "ğŸ”§ Tool Call | Agent: {AgentId} | Function: {FunctionName} | Args: {Args}",
        currentExecutorId,
        functionCall.Name,
        JsonSerializer.Serialize(functionCall.Arguments));
    break;

case FunctionResultContent functionResult:
    var resultPreview = functionResult.Result?.ToString() ?? "(null)";
    if (resultPreview.Length > 200)
    {
        resultPreview = resultPreview.Substring(0, 200) + "...";
    }
    _logger?.LogInformation(
        "âœ… Tool Result | Agent: {AgentId} | CallId: {CallId} | Preview: {Preview}",
        currentExecutorId,
        functionResult.CallId,
        resultPreview);
    break;
```

**æ—¥å¿—ç‰¹ç‚¹:**
- ğŸ“ ä½¿ç”¨è¡¨æƒ…ç¬¦å·æ ‡è¯†ä¸åŒç±»å‹
- ğŸ“ é™åˆ¶ç»“æœé¢„è§ˆé•¿åº¦ï¼ˆé¿å…æ—¥å¿—è¿‡å¤§ï¼‰
- ğŸ” åŒ…å«å…³é”®ä¿¡æ¯ï¼ˆCallId, å‚æ•°ç­‰ï¼‰
- ğŸ¯ ä¾¿äºé—®é¢˜å®šä½å’Œæ€§èƒ½ç›‘æ§

## ğŸ¯ é¢„æœŸçš„å®Œæ•´æ‰§è¡Œæµç¨‹

### ç”¨æˆ·è¯·æ±‚
```
@Artsy è¯·å¸®æˆ‘ç”Ÿæˆä¸€å¼ ç¾ä¸½çš„å¤•é˜³é£æ™¯ç”»
```

### æ—¥å¿—è¾“å‡º
```
[Information] ğŸ”§ Tool Call | Agent: Artsy | Function: text_to_image | Args: {"prompt":"ç¾ä¸½çš„å¤•é˜³é£æ™¯ç”»","size":"1024x1024"}
[Information] âœ… Tool Result | Agent: Artsy | CallId: call_123 | Preview: {"content":[{"type":"text","text":"{\"results\": [\"https://dashscope...
[Debug] ğŸ“ Text | Agent: Artsy | Content: 'æˆ‘ä¸ºæ‚¨åˆ›ä½œäº†ä¸€å¹…ç¾ä¸½çš„å¤•é˜³é£æ™¯ç”»...'
[Debug] ğŸ“„ Accumulated text for Artsy, total length: 156
```

### Agent å“åº”
```
æˆ‘ä¸ºæ‚¨åˆ›ä½œäº†ä¸€å¹…ç¾ä¸½çš„å¤•é˜³é£æ™¯ç”»ã€‚ç”»é¢ä¸­å±•ç°äº†æ¸©æš–çš„æ©™çº¢è‰²å¤©ç©ºï¼Œ
å¤ªé˜³ç¼“ç¼“è½ä¸‹ï¼Œåœ°å¹³çº¿ä¸Šæœ‰èµ·ä¼çš„å±±å³¦å‰ªå½±ã€‚æ•´ä½“è‰²è°ƒæ¸©é¦¨æµªæ¼«ã€‚

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥æŸ¥çœ‹ï¼š
https://dashscope-result-xxx.oss-cn-xxx.aliyuncs.com/xxx/image.png
```

## ğŸŒŸ å…³é”®ä¼˜åŠ¿

### 1. **é€šç”¨æ€§**
- âœ… é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„å·¥å…·
- âœ… æ— éœ€ä¸ºæ¯ç§å·¥å…·ç¼–å†™ç‰¹å®šé€»è¾‘
- âœ… è‡ªåŠ¨é€‚åº”æ–°å·¥å…·

### 2. **ç”¨æˆ·ä½“éªŒ**
- âœ… è‡ªç„¶è¯­è¨€å“åº”
- âœ… æœ‰ä¸Šä¸‹æ–‡å’Œè§£é‡Š
- âœ… æ ¼å¼åŒ–è‰¯å¥½
- âœ… ç¬¦åˆç”¨æˆ·æœŸæœ›

### 3. **å¯ç»´æŠ¤æ€§**
- âœ… ä»£ç ç®€æ´
- âœ… é€»è¾‘æ¸…æ™°
- âœ… æ˜“äºæ‰©å±•
- âœ… å‡å°‘ bug

### 4. **çµæ´»æ€§**
- âœ… LLM å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡è°ƒæ•´è¾“å‡ºæ ¼å¼
- âœ… å¯ä»¥ç»“åˆå¤šä¸ªå·¥å…·çš„ç»“æœ
- âœ… å¯ä»¥åœ¨å“åº”ä¸­æ·»åŠ å»ºè®®å’Œåç»­é—®é¢˜

### 5. **æ€§èƒ½**
- âœ… æ— éœ€é¢å¤–çš„è§£æé€»è¾‘
- âœ… å‡å°‘äº†ä»£ç å¤æ‚åº¦
- âœ… é™ä½äº†ç»´æŠ¤æˆæœ¬

## ğŸ”„ å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·å‘é€æ¶ˆæ¯                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Workflow è·¯ç”±åˆ° Specialist Agent                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LLM åˆ†ææ¶ˆæ¯ï¼Œå†³å®šè°ƒç”¨å·¥å…·                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          [FunctionCallContent] - æˆ‘ä»¬è®°å½•æ—¥å¿—                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FunctionInvokingChatClient è‡ªåŠ¨æ‰§è¡Œå·¥å…·                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          [FunctionResultContent] - æˆ‘ä»¬è®°å½•æ—¥å¿—                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     FunctionInvokingChatClient è‡ªåŠ¨å°†ç»“æœå‘å› LLM              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        LLM ç†è§£ã€æ•´åˆã€æ¶¦è‰²å·¥å…·ç»“æœï¼Œç”Ÿæˆæœ€ç»ˆæ–‡æœ¬                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       [TextContent] - âœ… æˆ‘ä»¬æå–å¹¶è¿”å›ç»™ç”¨æˆ·                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä»£ç å¯¹æ¯”æ€»ç»“

### âŒ ä¹‹å‰çš„é”™è¯¯åšæ³•
```csharp
// æ‰‹åŠ¨æå–å¹¶è¿½åŠ å·¥å…·ç»“æœ
case FunctionResultContent functionResult:
    var toolResult = ExtractToolResult(functionResult);  // æ‰‹åŠ¨è§£æ
    currentSummary.Content += toolResult;                // ç›´æ¥è¿½åŠ 
    break;
```

### âœ… æ­£ç¡®çš„æœ€ä½³å®è·µ
```csharp
// åªè®°å½•æ—¥å¿—ï¼Œè®© LLM å¤„ç†ç»“æœ
case FunctionResultContent functionResult:
    _logger?.LogInformation("âœ… Tool Result | ...");  // ä»…è®°å½•
    break;  // ä¸æ‰‹åŠ¨æå–

// åªæå– LLM çš„æœ€ç»ˆæ–‡æœ¬
if (!string.IsNullOrEmpty(agentUpdate.Update.Text))
{
    currentSummary.Content += agentUpdate.Update.Text;  // LLM å·²æ¶¦è‰²
}
```

## ğŸ“ æ ¸å¿ƒæ•™è®­

1. **ä¿¡ä»» LLM** - LLM æ¯”æˆ‘ä»¬æ›´æ“…é•¿ç†è§£å’Œå‘ˆç°æ•°æ®
2. **ç®€åŒ–é€»è¾‘** - ä¸è¦è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œè®©æ¡†æ¶åšå®ƒè¯¥åšçš„äº‹
3. **é€šç”¨è®¾è®¡** - è®¾è®¡åº”è¯¥é€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼Œè€Œä¸æ˜¯ç‰¹å®šåœºæ™¯
4. **ç›‘æ§ä¸å¹²é¢„** - è®°å½•æ—¥å¿—ç”¨äºç›‘æ§ï¼Œä½†ä¸å¹²é¢„è‡ªåŠ¨æµç¨‹
5. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ** - æœ€ç»ˆç›®æ ‡æ˜¯æä¾›è‡ªç„¶ã€å‹å¥½çš„ç”¨æˆ·ä½“éªŒ

## ğŸš€ åç»­å¯èƒ½çš„ä¼˜åŒ–

### 1. åŠ¨æ€è°ƒæ•´ System Prompt
æ ¹æ®å·¥å…·ç±»å‹åŠ¨æ€è°ƒæ•´æç¤ºè¯ï¼š
```csharp
if (mcpTools.Any(t => t.Name.Contains("image")))
{
    instructions += "\nFor image generation, describe the image and provide the URL.";
}
```

### 2. ç»“æœéªŒè¯
åœ¨ LLM å¤„ç†ä¹‹å‰éªŒè¯å·¥å…·ç»“æœï¼š
```csharp
case FunctionResultContent functionResult:
    if (functionResult.Result == null)
    {
        _logger?.LogWarning("Tool returned null result");
    }
    break;
```

### 3. æ€§èƒ½ç›‘æ§
è®°å½•å·¥å…·è°ƒç”¨çš„æ€§èƒ½æŒ‡æ ‡ï¼š
```csharp
case FunctionCallContent functionCall:
    var sw = Stopwatch.StartNew();
    // ... ç­‰å¾…ç»“æœ ...
    _logger?.LogInformation("Tool {Name} took {Ms}ms", name, sw.ElapsedMilliseconds);
    break;
```

ä½†æ ¸å¿ƒåŸåˆ™ä¸å˜ï¼š**è®© LLM å¤„ç†ç»“æœï¼Œæˆ‘ä»¬åªè´Ÿè´£æå–æœ€ç»ˆæ–‡æœ¬ã€‚**
