# 代码修复对比 - Agent Group Chat

## 修改 1: Triage Agent 系统提示

### ❌ 修复前 (第 100-107 行)

```csharp
var triageAgent = new ChatClientAgent(_chatClient,
	"You are a triage agent that routes messages to the appropriate agent based on mentions. " +
	"When a user mentions an agent with @AgentName, handoff to that agent. " +
	"Available agents: @Sunny (cheerful), @Techie (tech-savvy), @Artsy (artistic), @Foodie (food-loving). " +
	"If no specific agent is mentioned, respond with a friendly greeting and list available agents.",
	"triage",
	"Routes messages to the appropriate agent");
```

**问题**: 
- ⚠️ "respond with a friendly greeting" 允许 triage agent 自己回复
- ⚠️ 没有明确要求 "ALWAYS handoff"
- ⚠️ 可能导致 triage agent 不转发消息

### ✅ 修复后 (第 100-107 行)

```csharp
var triageAgent = new ChatClientAgent(_chatClient,
	"You are a triage agent that routes messages to the appropriate agent based on mentions. " +
	"When a user mentions an agent with @AgentName, you MUST handoff to that agent immediately. " +
	"Available agents: @Sunny (cheerful), @Techie (tech-savvy), @Artsy (artistic), @Foodie (food-loving). " +
	"ALWAYS handoff to another agent. Do NOT respond yourself - only route to the appropriate agent. " +
	"If no specific agent is mentioned, handoff to Sunny.",
	"triage",
	"Routes messages to the appropriate agent");
```

**改进**:
- ✅ "you MUST handoff" - 强制要求切换
- ✅ "ALWAYS handoff" - 明确指令
- ✅ "Do NOT respond yourself" - 禁止自己回复
- ✅ "handoff to Sunny" - 有默认行为

---

## 修改 2: 文本内容提取逻辑

### ❌ 修复前 (第 173 行)

```csharp
await foreach (WorkflowEvent evt in run.WatchStreamAsync())
{
	if (evt is AgentRunUpdateEvent updateEvent)
	{
		if (updateEvent.ExecutorId != currentAgentId)
		{
			// ... 切换 agent 逻辑
		}
        
		responseText.Append(updateEvent.Update.Text);  // ⚠️ 问题：只使用 Text 属性
	}
	else if (evt is WorkflowOutputEvent)
	{
		// ... 保存最终消息
	}
}
```

**问题**:
- ⚠️ 只依赖 `updateEvent.Update.Text`
- ⚠️ 如果 `Text` 为空或 null，会丢失消息内容
- ⚠️ 没有从 `Contents` 集合中提取内容的备用方案

### ✅ 修复后 (第 147-193 行)

```csharp
await foreach (WorkflowEvent evt in run.WatchStreamAsync())
{
	// ✅ 添加调试日志
	Console.WriteLine($"[DEBUG] Event type: {evt.GetType().Name}");
    
	if (evt is AgentRunUpdateEvent updateEvent)
	{
		// ✅ 详细的调试信息
		Console.WriteLine($"[DEBUG] AgentRunUpdateEvent - ExecutorId: {updateEvent.ExecutorId}, Update.Text: '{updateEvent.Update.Text}'");
        
		if (updateEvent.ExecutorId != currentAgentId)
		{
			// ... 切换 agent 逻辑
		}

		// ✅ 改进的文本提取逻辑 - 有备用方案
		var updateText = updateEvent.Update.Text;
		if (!string.IsNullOrEmpty(updateText))
		{
			responseText.Append(updateText);
		}
		else if (updateEvent.Update.Contents != null)
		{
			// 从 Contents 集合中提取 TextContent
			foreach (var content in updateEvent.Update.Contents)
			{
				if (content is Microsoft.Extensions.AI.TextContent textContent)
				{
					responseText.Append(textContent.Text);
				}
			}
		}
	}
	else if (evt is WorkflowOutputEvent)
	{
		// ... 保存最终消息
	}
}
```
